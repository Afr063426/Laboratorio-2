---
output:
  pdf_document:
    toc: true
    toc_depth: 2
    includes:
      in_header: preambulo.tex
      before_body: titulo.tex
     
documentclass: memoir
classoption: oneside

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, include=FALSE, warning=FALSE}


###Se cargan los paquetes y se cargan y limpian los datos
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(knitr)
library(xtable)
library(gridExtra)
library(Quandl)
require(xts)
require(YieldCurve)
library(Quandl)
datosAsia<-read.csv('asia.csv')
datos<-read.csv("USDdata.csv")
#datos<-Quandl("USTREASURY/YIELD")
datos$Date<-(as.Date(datos$Date,format="%m/%d/%Y"))
#datos<-datos[order(datos$Date),]
datos1Mo<-datos[datos$Date>=as.Date("2021-04-19"),-3]
datos10Y<-datos[datos$Date>=as.Date("2010-01-01"),-3]
datos1Y<-datos[datos$Date>=as.Date("2020-01-01"),-3]

### Se procede a calcular la media de las tasas de rendimiento
promedios1Mo<-datos1Mo%>%select(-1)%>%gather("Maduration","Rendimiento")%>%group_by(Maduration)%>%summarise_all(mean)
promedios10Y<-datos10Y%>%select(-1)%>%gather("Maduration","Rendimiento")%>%group_by(Maduration)%>%summarise_all(mean)
promedios1Y<-datos1Y%>%select(-1)%>%gather("Maduration","Rendimiento")%>%group_by(Maduration)%>%summarise_all(mean)

### Se pasan los rendimientos a meses

promedios1Mo$Maduration<-as.numeric(str_remove_all(promedios1Mo$Maduration,"[YRMOX.]"))*(str_detect(promedios1Mo$Maduration,"YR")*12+str_detect(promedios1Mo$Maduration,"MO"))
promedios1Mo<-promedios1Mo[order(promedios1Mo$Maduration),]
promedios1Mo<-cbind(promedios1Mo, "Varianza"=apply(datos1Mo[,-1],2,sd))


promedios1Y$Maduration<-as.numeric(str_remove_all(promedios1Y$Maduration,"[YRMOX.]"))*(str_detect(promedios1Y$Maduration,"YR")*12+str_detect(promedios1Y$Maduration,"MO"))
promedios1Y<-promedios1Y[order(promedios1Y$Maduration),]
promedios1Y<-cbind(promedios1Y, "Varianza"=apply(datos1Y[,-1],2,sd))

promedios10Y$Maduration<-as.numeric(str_remove_all(promedios10Y$Maduration,"[YRMOX.]"))*(str_detect(promedios10Y$Maduration,"YR")*12+str_detect(promedios10Y$Maduration,"MO"))
promedios10Y<-promedios10Y[order(promedios10Y$Maduration),]
promedios10Y<-cbind(promedios10Y, "Varianza"=apply(datos10Y[,-1],2,sd))


```


``` {r echo=FALSE, message=FALSE, warning=FALSE}
### Se program las funciones que se van emplear
##Modelo de Nelson-Siegel para curvas de rendimiento
NS<-function(theta,tiempo){
  yield<-(theta[1]+(theta[2]+theta[3]/theta[4])*(1-exp(-theta[4]*tiempo))/(theta[4]*tiempo)-theta[3]/theta[4]*exp(-theta[4]*tiempo))
  yield
}

## Se debe ajustar la curva entonces esto se busca reducir la suma de cuadrados, con la siguiente funci'on
fitNS<-function(theta,tiempo,rendimientos){
  fn<-function(theta){
    sum((rendimientos-NS(theta,tiempo))^2)
  }
  optim(theta,
        fn,
        method = "L-BFGS-B",
        lower= rep(-1,4),
        upper=rep(1,4)
        )
}

```


\chapter{Resumen Ejecutivo 1}
Aquí debe dar resultados generales de lo que obtuvo del análisis.

\chapter{Introducción 1}

\chapter{Objetivos 1}

\section{Objetivo general}

Analizar la curva de rendimiento de los bonos del tesoro de Estados Unidos de Norte América por medio del modelo de Nelson y Siegel en el periodo de años comprendido entre el 1° de enero del 2010 y el  20 de mayo del 2021.

\section{Objetivos específicos}
\begin{enumerate} 

\item Explicar el modelo de Nelson y Siegel.

\item Describir las características de la base de datos de los bonos del tesoro de Estados Unidos de Norte América.

\item Implementar el modelo de Nelson y Siegel en lenguaje de programación R, para la base de datos de los bonos del tesoro de Estados Unidos de Norte América.

\item Evaluar los resultados obtenidos apartir del modelo de Nelson y Siegel.

\end{enumerate}





\chapter{Marco teórico 3}
\par La curva de rendimiento es una herramienta útil a la hora de quererse invertir o negociar un instrumento financiero y al momento de aplicar políticas monetarias.

\par \textbf{rendimientos spot definir}
\par Se procede a explicar qué es la curva de rendimiento, según Boudreault y Reanud (2019) la curva de rendimiento también llamada curva de rendimientos spot. Esta curva muestra la relación que hay entre las tasa de rendimiento spot y el tiempo de maduración. Así esta curva muestra los rendimientos que se obtienen de mantener una cierta cantidad de dinero durante un tiempo determinado. Se puede determinar el rendimiento mediante
\[
y=\left(\frac{F}{B_0}\right)^{\frac{1}{T}}-1
\]
Donde 
\begin{table}[H]
\begin{tabular}{c|c}
$y$ & Tasa de rendimiento\\
$T$ & Tiempo para la maduración\\
$B_0$ & Costo de la inversión o precio del bono\\
$F$ & Monto a recibir al final del periodo
\end{tabular}
\end{table}
\par Sin embargo a pesar de que esta herramienta es ampliamente utilizada, tiene una limitante intertemporal. Como lo expone Camilo (2008) esta se construye a través de una serie de tasas (precios) de instrumentos financieros discontinuos en el tiempo. Esto implica que entonces lo se ubica a partir de las tasas de rendimiemto es una serie de puntos que no reflejan de forma continua las tasas de rendimiento en el mercado financiero de acuerdo a su tiempo de maduración.
\par Sin embargo hay agentes los cuales no están dispuestos a invertir o prestar los montos al tiempo establecido por agentes como los gobiernos nacionales u otras empresas. Es por esta razón que sería de utilidad encontrar una curva suave la cual sea capaz de proyectar las tasas de rendimiento en distintos momentos del tiempo, pero basado en lo que anteriormente han establecido agentes como los gobiernos nacionales.
\par Para lograr obtener una curva suave la cual se aproxime a las tasas de rendimiento de agentes como los gobiernos, se emplean distintos métodos entre ellos los métodos paramétricos que están basados en la construcción de curvas a partir de modelos paramétricos. (Choudhry, 2010)
\par Entre los modelos paramétricos se encuentra el de Nelson-Siegel. El cual según Matteson (2015) describe las tasas forward con la siguiente curva
\[
r(t,\theta)=\theta_0+(\theta_1+\theta_2t)\exp(-\theta_3 t)
\]
A partir de esta se puede obtener que la curva de rendimiento continua se puede obtener haciendo
\[
\begin{split}
y(t,\theta)&=t^{-1}\int_{0}^{t}r(x,\theta)dx\\
&=\theta_0+\left(\theta_1+\frac{\theta_2}{\theta_3}\right)\frac{1-\exp(-\theta_3 t)}{\theta_3 t}-\frac{\theta_2}{\theta_3}\exp(-\theta t)
\end{split}
\]
Tal y como lo citan Hladíková y Radová (2012) este modelo tiene una interpretación económica interesante para los parámetros. Tomando la curva que describe las tasas forward 
Primero
\[
\lim_{t\to\infty}r(t,\theta)=\theta_{0}\qquad \lim_{t\to 0}r(t,\theta)=\theta_0+\theta_1
\]
\begin{itemize}
\item Entonces $\beta_0>0$ representa la asintota horizontal de la curva 
\end{itemize}





\chapter{Descripción de los datos 5}
Debe ser una descripción breve e incluir algún gráfico que permita tener una buena comprensión de sus datos.

Entre las descripciones de las variables sería bueno el detalle de la que considera la más importante de su modelo, puede que tenga que calcular la media, por ejemplo, si mis datos son 

Grafico de todos los datos:

```{r}

Datosgra10Y<-gather(datos10Y, "Fecha de maduración", Obtenido, names(datos10Y[2]):names(datos10Y[length(datos10Y)]))

ggplot( data =Datosgra10Y, mapping = aes(x = Date, y = Obtenido, group=`Fecha de maduración`, color=`Fecha de maduración`)) + 
    geom_line()+
    scale_color_discrete(labels=c("1 mes", "6 meses", "1 año", "2 año", "3 año","5 año","7 año", "10 año","20 año","30 año"))+
      labs(
      y = "Monto",
      x = "Tiempo",
      title = "Comportamiento del bono"
      ) +
    theme(legend.position="bottom")+
    theme(plot.title = element_text(hjust = .5))# colocamos el titulo en el centro
```


Promedio y Desviación de los 3 

```{r}

# ggplot( data= promedios10Y , mapping = aes(x = Maduration, y = Rendimiento)) + 
#     geom_point()+
#     geom_point(data= promedios10Y, mapping = aes(x = Maduration, y =Varianza))+
#   xlab('Fecha de maduración') + 
#   ylab('Tasas spot') +
#   ggtitle('Distribución de las tasa spot') + 
#     theme(legend.position="bottom")+
#     theme(plot.title = element_text(hjust = .5))# colocamos el titulo en el centro
```


```{r}
# 
# ggplot(Datosgra10Y) + 
#   geom_density(aes(x = Obtenido, fill = `Fecha de maduración`), position = 'stack') + 
#   
#   xlab('Fecha de maduración') + 
#   ylab('Tasas spot') +
#   ggtitle('Distribución de las tasa spot') + 
#   theme_minimal() +
#   theme(legend.position="none")
```






```{r}
ggplot(data = Datosgra10Y, aes(x =`Fecha de maduración` , y = Obtenido, group=`Fecha de maduración`)) + geom_boxplot(aes(color = `Fecha de maduración`), alpha = 0.7) + 
  xlab('Fecha de maduración') + 
  ylab('Tasas spot') +
  ggtitle('Distribución de las tasa spot') + 
  theme_minimal()
```





```{r}
Datosgra1Y<-gather(datos1Y, "Fecha de maduración", Obtenido, names(datos1Y[2]):names(datos1Y[length(datos1Y)]))

ggplot(data = Datosgra1Y, aes(x =`Fecha de maduración` , y = Obtenido, group=`Fecha de maduración`)) + geom_boxplot(aes(color = `Fecha de maduración`), alpha = 0.7) + 
  xlab('Fecha de maduración') + 
  ylab('Tasas spot') +
  ggtitle('Distribución de las tasa spot') + 
  theme_minimal()
```


```{r}
Datosgra1Mo<-gather(datos1Mo, "Fecha de maduración", Obtenido, names(datos1Mo[2]):names(datos1Mo[length(datos1Mo)]))

ggplot(data = Datosgra1Mo, aes(x =`Fecha de maduración` , y = Obtenido, group=`Fecha de maduración`)) + geom_boxplot(aes(color = `Fecha de maduración`), alpha = 0.7) + 
  xlab('Fecha de maduración') + 
  ylab('Tasas spot') +
  ggtitle('Distribución de las tasa spot') + 
  theme_minimal()
```




Descripcion de lo de la pandemia







``` {r echo=FALSE, message=FALSE, warning=FALSE}
dat<- c(1:4)
kable(dat  , format = "latex" , booktabs=TRUE , align = 'clcc' , caption = "Ejemplo de formato para tabla",)%>%
  kable_styling(full_width = F, position = "center", latex_options = "HOLD_position")
```


\par Profe en vista de que los anteriores datos no sirve porque corresponden a las tasas de rendimiento (spot) entonces encontramos los datos de la región de Asia descargados el día 21 de mayo del 2021 de la página https://es.tradingview.com/markets/bonds/prices-asia/ el asunto con estos es que cuentan con cupones y no contamos con las tasas para traer los flujos a valor presente. 

\par Lo que pensamos es que se podría intentar calcaular las tasas spot de una forma similar a la que se presenta en el código de la metodología el último gráfico donde basado en los cupones y precio del bono así como su tiempo de maduración se usa el modelo de Nelson y Siegel. Y se planteaba la idea de sacar las tasas para los países de la región y sacar un promedio de estas para visualizar cuáles podrían ser las tasas de los bonos en esta región. La idea de implementar lo quese hizo a la metodología surgió del hecho de no poder hacer bootstraping cuando habían saltos de más de un año entre periodos y teniendo en cuenta que se tenían cupones.
\par Se muestra un análisis de los datos unificados por tiempo de maduración del bono ignorando el país.


``` {r echo=FALSE, message=FALSE, warning=FALSE}
datosAsia<-datosAsia%>%group_by(Maduration)
ggplot(data = datosAsia, aes(x =Maduration , y = Precio, group=Maduration,color=Maduration)) + geom_boxplot( alpha = 0.7) + 
  xlab('Fecha de maduración') + 
  ylab('Precio') +
  ggtitle('Distribución de los precios Asia') + 
  theme_minimal()
```
\chapter{Metodología 1}
Cómo implementa la teoría expuesta en el marco teórico con sus datos, colocaremos aquí los resultados que se vayan obteniendo, incluir al menos un gráfico.


``` {r echo=FALSE, message=FALSE, warning=FALSE}
### Se procede a calcular a los parametros

## Se guaradan los datos importantes
t<-c(0,0,0,0.0003)
fitting1Mo<-fitNS(t,promedios1Mo$Maduration,promedios1Mo$Rendimiento)
paramters1Mo<-unlist(fitting1Mo[1])

fitting1Y<-fitNS(c(0,0,0,0.01),promedios1Y$Maduration,promedios1Y$Rendimiento)
paramters1Y<-unlist(fitting1Y[1])

fitting10Y<-fitNS(t,promedios10Y$Maduration,promedios10Y$Rendimiento)
paramters10Y<-unlist(fitting10Y[1])
### Ploteamos
time<-seq(from=0,to=360,by=1)

ggplot()+geom_line(aes(x=time,y=NS(paramters1Mo,time)))+geom_point(aes(x=promedios1Mo$Maduration,y=promedios1Mo$Rendimiento))
ggplot()+geom_line(aes(x=time,y=NS(paramters1Y,time)))+geom_point(aes(x=promedios1Y$Maduration,y=promedios1Y$Rendimiento))
ggplot()+geom_line(aes(x=time,y=NS(paramters10Y,time)))+geom_point(aes(x=promedios10Y$Maduration,y=promedios10Y$Rendimiento))
```





``` {r echo=FALSE, message=FALSE, warning=FALSE}
### Prueba
### Profe en vista de que no podiamos hacer boostraping hasta los 30 años entonces lo que hicimos ###tratar de generar los parámetros trayendo a valor presenta los flujos y restar los flujos ###traídos a valor presente al precio presente. Eso es lo que se muestra acontinuación. Solo se está aplicando  para el caso de Japón a 30 años sin embargo se pensó en hacerse para todos los demás paises y así sacar un promedio de lo podrían ser las tasas de rendimiento en el área de Asia. Comprendiendido Japón, India, Corea, China, Hong Kong, Taiwan, Indonesia, Malasia y Tailandia. Estos datos corresponden al dia 21 de mayo del 2021
### También se pensó en calcular las tasas de forma directa a partir de los precio sin embargo los únicos periodos para los que se encontraron cero cupón eran de 1 mes a 10 años y de ahí en adelante todos los demás tenían cupones
optimizacion<-function(price,theta,maduracion,cupon){
  fn<-function(theta){
    price-sum(100*cupon/(1+NS(t,c(1:maduracion)))^(c(1:maduracion))+100/NS(theta,maduracion))
  }
  optim(theta,
        fn,
        method = "L-BFGS-B",
        lower= rep(-1,4),
        upper=rep(1,4)
        )
}
t<-c(0.05,0.05,0.05,0.05)
parametros<-unlist(optimizacion(100.117,t,30,0.0263)[1])
ggplot()+geom_line(aes(x=c(1:30),y=NS(parametros,c(1:30))))
```

\chapter{Conclusiones y recomendaciones 1}



\chapter{Referencias bibliográficas}
\nocite{*}
\printbibliography

\chapter{Anexos}
