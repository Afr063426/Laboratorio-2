---
output:
  pdf_document:
    toc: true
    toc_depth: 2
    includes:
      in_header: preambulo.tex
      before_body: titulo.tex
     
documentclass: memoir
classoption: oneside

---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
###Se cargan los paquetes y se cargan y limpian los datos
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(knitr)
library(xtable)
library(gridExtra)
library(latex2exp)
### Se cargan los datos
datosBrasil<-read.csv('datosCombiandos.csv')
datosBrasil$FechaDeMaduracion<-as.Date(datosBrasil$FechaDeMaduracion)
datosBrasil$FechaDeValoracion<-as.Date(datosBrasil$FechaDeValoracion)
```



``` {r echo=FALSE, message=FALSE, warning=FALSE}
### Se programa las funciones que se van emplear
##Modelo de Nelson-Siegel para curvas de rendimiento
NS<-function(theta,tiempo){
yield<-(theta[1]+(theta[2]+theta[3]/theta[4])*(1-exp(-theta[4]*tiempo))/(theta[4]*tiempo)-theta[3]/theta[4]*exp(-theta[4]*tiempo))
yield
}
## Periodos en años pago de cupones
periodos<-function(tiempo){
if(tiempo>=1){
v<-(tiempo>=1& tiempo-floor(tiempo)>0.5)*c(tiempo-floor(tiempo)-0.5,tiempo-floor(tiempo)-0.5+seq(0.5,floor(tiempo)+0.5,by=0.5))+(tiempo>=1& tiempo-floor(tiempo)==0.5)*seq(0.5,floor(tiempo)+0.5,by=0.5)+(tiempo>=1& tiempo-floor(tiempo)==0)*c(seq(0.5,floor(tiempo),by=0.5))+(tiempo>=1&tiempo-floor(tiempo)<0.5)*c(tiempo-floor(tiempo),tiempo-floor(tiempo)+seq(0.5,floor(tiempo),by=0.5))
}else{
  v<-(tiempo<=0.5)*tiempo+(tiempo<1& tiempo-floor(tiempo)>0.5)*c(tiempo-floor(tiempo)-0.5,tiempo)
}
if(v[length(v)-1]>v[length(v)]){
  v<-v[-length(v)]
}
return(v)
}


## Se debe ajustar la curva con los precios entonces esto se busca reducir la suma de cuadrados, con la siguiente funci'on
fitNS<-function(theta,tiempo,price,R,C){
fn<-function(theta){
restaCuadrados<-c()
for(i in 1:length(tiempo)){
  restaCuadrados<-c(restaCuadrados,(price[i]-(R*exp(-tiempo[i]*NS(theta,tiempo[i])))-R*C[i]*sum(exp(-periodos(tiempo[i])*NS(theta,periodos(tiempo[i])))))^2)
}
sum(restaCuadrados)
}
optim(theta,
    fn,
    method = "L-BFGS-B",
    lower= rep(-20,4),
    upper=rep(20,4)
    )
}
```


\chapter{Resumen Ejecutivo 1}
\begin{itemize}
\item El hacer una promediación de los datos al momento de determinar una curva de rendimiento genera un gran error bajo el modelo de Nelson-Siegel, al menos para el caso de los bonos del Tesoro Nacional de Brasil.
\item Ligado a lo anterior el sacar un promedio es una opción para determinar la curva de rendimientos, sin embargo esto puede estar alejado de la realidad además de que se puede generar un gran error.
\item El tomar la mediana similar a la media genera un gran un error a demás de que puede no representar la realidad de la mejor forma.
\item En los casos reales que sean valorado como los son tomar el máximo de los precios y con ello todas las valoraciones que se hicieron la fecha ligada este precio, así como el mínimo y el caso de la última valoración con la que se cuenta datos muestran un buen ajuste bajo el modelo de Nelson-Siegel.
A continuación se muestra un resumen de los resultados obtenidos.
\end{itemize}
``` {r echo=FALSE, message=FALSE, warning=FALSE}
###Generacion de tabla resumen ejecutivo
resumen<-read.csv("datosResumenParametros.csv")[-1]
kable(resumen,col.names = c("Fecha De Valoracion", "Caso", "$\\theta_0$","$\\theta_1$","$\\theta_2$","$\\theta_3$","Error"),escape=F, format = "latex" , booktabs=TRUE , align = 'clcc' , caption = "Resumen De Paramétros Obtenidos",)%>%
   kable_styling(full_width = F, position = "center", latex_options = "HOLD_position")
```
\chapter{Introducción 1}

\chapter{Objetivos 1}

\section{Objetivo general}

Analizar la curva de rendimiento de los bonos del Tesoro Nacional de la República Federativa De Brasil por medio del modelo de Nelson y Siegel en el periodo de tiempo comprendido entre el 1° de enero del 2020 y el  27 de mayo del 2021.

\section{Objetivos específicos}
\begin{enumerate} 

\item Explicar el modelo de Nelson y Siegel.

\item Describir las características de la base de datos de los bonos del Tesoro Nacional de la República Federativa de Brasil.

\item Implementar el modelo de Nelson y Siegel en lenguaje de programación R, para la base de datos de los de bonos del Tesoro Nacional de la República Federativa de Brasil.

\item Establecer las curvas de rendimiento de los bonos del Tesoro Nacional de la República Federativa de Brasil.

\item Evaluar los resultados obtenidos apartir del modelo de Nelson y Siegel.

\end{enumerate}





\chapter{Marco teórico 3}
\par La curva de rendimiento es una herramienta útil al momento de invertir o negociar un instrumento financiero y al momento de aplicar políticas monetarias. Primero se presenta una tabla con notación.

\begin{table}[H]
\centering
\begin{tabular}{cl}
\hline
Notación & Información\\
\hline 
$T$   & Tiempo para la maduración a partir del presente o tiempo restante\\& para pago de un monto de dinero.               \\
$y_T$   & Tasa de rendimiento, también denota la spot.\\
$r_T$ & La tasa forward es la tasa efectiva en un año o periodo dadas las spot $\frac{(1+y_k)^{k}}{(1+y_{k-1})^{k-1}}-1$.\\
$d_T$ & Tasa de descuento, se usa para valorar un monto pagado en el futuro en el presente.\\
$B_0$ & Costo de la inversión o precio del bono. \\
$F$   & Facial, también puede ser igual al valor de redención pero no siempre es así.\\  
$R$ & Valor de redención, es el monto pagado a parte de los cupones y\\& es pagado en la fecha de maduración.\\
$C$ & Tasa de cupón que se paga de forma periodica que se hace sobre el valor del facial.\\
\hline
\end{tabular}
\end{table}
\par Se procede a explicar qué es la curva de rendimiento, según Boudreault y Reanud (2019) la curva de rendimiento también llamada curva de rendimientos spot, muestra la relación que hay entre las tasa de rendimiento spot y el tiempo de maduración. Así esta curva muestra los rendimientos que se obtienen de mantener una cierta cantidad de dinero durante un tiempo determinado. Para el caso de bonos cero cupón se puede calcular usando
\begin{equation}
y_T=\left(\frac{F}{B_0}\right)^{\frac{1}{T}}-1
\label{ceroCupon}
\end{equation}
\par Sin embargo a pesar de que los rendimientos ofrecidos por entidades como lo son lo son los gobiernos con sus bonos son ampliamente utilizados. Como lo expone Camilo (2008) esto tiene una limitante temporal donde lo que se obtiene es una serie de puntos los cuales no representan las tasas y los rendimientos de forma continua. Esto es una limitante para los agentes los cuales no están dispuestos a ofrecer
\par Para lograr obtener una curva suave la cual se aproxime a las tasas de rendimiento de agentes como los gobiernos, se emplean distintos métodos entre ellos los métodos paramétricos que están basados en la construcción de curvas a partir de modelos paramétricos. (Choudhry, 2010)
\par Entre los modelos paramétricos se encuentra el de Nelson-Siegel. El cual según Matteson (2015) describe las tasas forward con la siguiente curva
\begin{equation}
r(T,\theta)=\theta_0+(\theta_1+\theta_2T)\exp(-\theta_3 T)
\label{forwardNS}
\end{equation}
\par De tal forma que los parámetros son $\theta_0,\theta_1,\theta_2,\theta_3$ y $t$ es el periodo. A partir de esta se puede obtener la curva de rendimiento continua haciendo
\begin{equation}
y(T,\theta)=T^{-1}\int_{0}^{T}r(x,\theta)dx=\theta_0+\left(\theta_1+\frac{\theta_2}{\theta_3}\right)\frac{1-\exp(-\theta_3 t)}{\theta_3 t}-\frac{\theta_2}{\theta_3}\exp(-\theta_3 t
\label{rendimiento}
\end{equation}
Se puede calcular el valor de un flujo en el futuro en el periodo 
$T_i$ traído a valor presente mediante 
\begin{equation}
d(T_i,\theta)=\exp\left(-\int_{0}^{T_i}r(t,\theta)dt\right)
\label{descuento}
\end{equation}
Cuando se emplea esto es importante tener presente que se está incurriendo en un cierto grado de error con respecto al valor real que tendría el flujo en el presente. A $d$ se le llamará factor de descuento haciendo uso de esto es posible obtener un aproximación del precio de un bono con tiempo de maduración $T_n$ y que paga cupones en cada periodo $T_i$ quedando de la siguiente forma
\begin{equation}
P_n(\theta)=Rd(T_n,\theta)+\sum_{i=1}^{n}FCd(T_i,\theta)
\label{descuento}
\end{equation}
Con esto también se puede calcular el precio de los bonos cero cupón basta tomar $C=0$.
\par Se pueden calcular los parámetros de un modelo paramétrico mediante la suma de residuo de cuadrados que es 
\begin{equation}
\sum_{i} (\tilde{M}_i-M(l_i,\beta))
\label{sumaderesiduo}
\end{equation}
Donde $\tilde{M}_i$ es el dato real, $M(l_i,\beta)$ es la funci\'on del modelo param\'etrico, $l_i$ es la variable de la que depende puede ser tiempo y $\beta$ es el vector de parámetros, optimizando mediante herramientas de cálculo se puede encontrar los paráametros que reducen el error entre los datos reales y lo que se obtiene mediante el modelo.(Ruppert y Matteson, 2015)
\par
Tal y como lo citan Hladíková y Radová (2012) este modelo tiene una interpretación económica interesante para los parámetros. Tomando la curva que describe las tasas forward 
Primero
\[
\lim_{T\to\infty}f(t,\theta)=\theta_{0}\qquad \lim_{T\to 0}f(t,\theta)=\theta_0+\theta_1
\]
\begin{itemize}
\item Entonces $\theta_0>0$ representa la asintota de la curva zero cupón
\item La suma de los parámetros $\theta_0+\theta_1$ representa el valor inicial de la curva de tasas forward por lo que $\theta_0+\theta_1>0$
\item También $\theta_1$ puede es explicada como la curvatura de la función o la diferencia entre las tasas de forward de termino largo y termino corto.
\end{itemize}
\par Antes de poder continuar es necesario dejar en claro lo que son los cuantiles, media y la desviación estandar. Según Evans y Rosenthal (2009).
\begin{tcolorbox}
\par \textbf{Cuántil}\par Para $p\in [0,1]$ el $p$-ésimo cuantil $x_p$, para la función distribución $F_X$ de la variable aleatoria $X$, se define como el menor número $x_p$ que satisface 
\[
p\leq F_X(x_p)
\]
\end{tcolorbox}
\par A partir de esta definición se define la mediana como el cuántil tal que $p=0.5$. Continuando con las definiciones de la media y desviación.
\begin{tcolorbox}
\textbf{Media}
\[
\mu_X=\frac{1}{|\Pi|}\sum_{\pi\in \Pi}X(\pi)
\]
\textbf{Desviación estándar}
\[
\sigma_X=\frac{1}{|\Pi|}\sqrt{\sum_{\pi\in \Pi} (X(\pi)-\mu_x)^2}
\]
Donde $\Pi$ son los datos y $X$ es el peso dado al dato. En particular la media práctica es 
\[
\bar{x}=\frac{1}{n}\sum_{i=1}^{n}x_i
\]
Y la desviación estándar práctica es
\[
\sigma_x=\sqrt{\frac{1}{n-1}\sum_{i=1}^{n}(x_i-\bar{x})^2}
\]
\par $x_i$ representa el dato $i$-ésimo. La media expresa alrededor de dónde se distribuyen los datos y la desviación estándar qué tanto se dispersan los datos con respecto a la media.
\end{tcolorbox}
\par Se procede a explicar los gráficos de caja y bigotes. Estos gráficos muestran 5 datos relevantes de los datos, así como la dispersión. En estos se muestran el dato con el valor más bajo (mínimo), la mediana de la primera mitad de los datos (cuartil 1, $Q_1$), la mediana de todos los datos (cuartil 2, $Q_2$), la mediana de la segunda mitad de los datos (cuartil 3 $Q_3$) y la observación de mayor valor (máximo), así como los posibles outliers (datos con un peso muy alejado del que tienen los demás datos). De los gráficos de caja y bigotes existen variaciones. Al momento de hacerse un gráfico de este estilo hay que tener presente varias desventajas como lo, es el visualizar como están distribuidos los datos, con respecto a los distintos cuartiles. (Marmolejo, 2011) 


``` {r echo=FALSE, message=FALSE, warning=FALSE,fig.width=5, fig.height=2,fig.align="center"}
caja<-data.frame(X=c(""),Y=c(1:5))
caja%>%ggplot(aes(x=X,y=Y,label=c('Min','Q_1','M','Q_3','Max')))+stat_boxplot(geom='errorbar')+geom_boxplot()+geom_text(vjust=6)+ggtitle("Gráfico representativo De Caja Y Bigotes")+theme(axis.text.x=element_blank(),axis.text.y=element_blank())+coord_flip()+labs(x="",y="")
```





















\chapter{Descripción de los datos 5}

```{r}

# Se crea una un data frame idéntica, para tratar los datos como factor y no como fechas, pues es más sencillo trabajar los gráficos.
datosDes<-datosBrasil

# Se seleccio el maximo de todos los precios y luego se toman los datos de esa fecha(ver si esto esta)


datosDes$TipoDeBono <- as.factor(datosDes$TipoDeBono)
datosDes$FechaDeMaduracion <- as.factor(datosDes$FechaDeMaduracion)
levels(datosDes$TipoDeBono) <- c("CeroCupón", "Cuponados")
# datosDes$FechaDeValoracion <- as.factor(datosDes$FechaDeValoracion)
# datosDes$Precio <- as.factor(datosDes$Precio)
# datosDes$TiempoRestanteParaMaduracion <- as.factor(datosDes$TiempoRestanteParaMaduracion)
# datosDes$CuponSemestral <- as.factor(datosDes$CuponSemestral )
#levels(datosDes$FechaDeMaduracion)
#levels(datosDes$TiempoRestanteParaMaduracion)
#max(datosDes$FechaDeValoracion)
#min(datosDes$FechaDeValoracion)
#levels(datosDes$CuponSemestral)



```





\par Los datos son obtenidos a partir del Tesoro Nacional de la República Federativa de Brasil, esto por medio de su página web, visitada el día 2021-05-27, la cual cuenta con una amplia descripción de los datos. Se tiene que los mismo son bonos denominados \textit{pre-fixados} , con la característica de contar con rentabilidad fija en el momento del vencimiento. Los bonos \textit{pre-fixados} se dividen en bonos cuponados llamado “juros” los cuales cuentan con una tasa cupón del 10% anual, es decir hacen pagos semestrales de 48.808848170152 y los bonos cero cupón, ambos pagan 1000 reales al vencimiento. 


\par Cabe destacar que tienen plazos fijos en sus bonos en este caso se tienen bonos que vencen en las fechas: 2022-01-01, 2023-01-01, 2024-07-01, 2025-01-01, 2026-01-01, 2027-01-01, 2029-01-01 y 2031-01-01. Como el facial está fijado, se tiene que, para el mismo plazo de vencimiento, el titulo con una mayor tasa de rentabilidad debe de tener un menor precio que uno con una rentabilidad más baja, pues en el mismo tiempo se va a pagar lo mismo.

\par En la misma línea se tiene que son los precios de un bono representativo del mercado, es decir los precios observados son aquellos que tienen los bonos con las mismas características, teniendo así que si al día hoy se quiere emitir un bono para esa fecha de maduración con el mismo facial la tasa de rendimiento debe ajustarse al precio que existe en el mercado secundario, como mínimo para que los inversionista se vean indiferentes y un tanto mayor para que estos tengan más interés en adquirirlos.

\par Lo anterior se puede extrapolar al mercado segundario, teniendo así que si se ajusta la tasa al precio del mercado ambos bonos tendrían el mismo precio, pero si se da una tasa de rendimiento mayor el precio será bajo y con el mismo beneficio, por lo que se va a contar con un comportamiento de los precios muy parecido entre si.


\par Ahora bien se parte de la base de datos que contiene los precios de los bonos, seleccionando sus ultimos 9 años, que van desde `r min(datosBrasil$FechaDeValoracion)` hasta `r max(datosBrasil$FechaDeValoracion)`, pero con el inconveniente de que no son datos homogéneos para poder trabajar, como se muestran en los siguientes gráficos:


```{r,  echo=FALSE}
#grafico con facet_wrap

# 
# 
# datosDes%>%ggplot(aes(x=FechaDeValoracion, y = Precio,group=FechaDeMaduracion, color=FechaDeMaduracion))+
#   geom_line()+
#   scale_color_discrete()+
#   facet_wrap(~ TipoDeBono)
#   labs(y = "Precios",x = "Tiempo",title = "Comportamiento de bonos cero cupón")+
#   theme(legend.position="bottom")+theme(plot.title = element_text(hjust = .5))# colocamos el titulo en el centro
```




``` {r, echo=FALSE}

#{r, fig.width=3, fig.height=2.5, echo=FALSE}
datosDes[datosDes$TipoDeBono=="CeroCupón",]%>%ggplot(aes(x=FechaDeValoracion, y = Precio, group=FechaDeMaduracion, color=FechaDeMaduracion))+
  geom_line()+
  scale_color_discrete(name = "Fecha de maduración")+
  labs(y = "Precios",x = "Tiempo",title = "Comportamiento de bonos cero cupón")+
  theme(legend.position="bottom")+
  theme(plot.title = element_text(hjust = .5))

datosDes[datosDes$TipoDeBono=="Cuponados",]%>%ggplot(aes(x=FechaDeValoracion, y = Precio,group=FechaDeMaduracion, color=FechaDeMaduracion))+
  geom_line()+
  scale_color_discrete(name = "Fecha de maduración")+
  labs(y = "Precios",x = "Tiempo", title = "Comportamiento de bonos cuponados")+
  theme(legend.position="bottom")+
  theme(plot.title = element_text(hjust = .5))


```

\par Siendo así que se necesitan eliminar los datos del bono cuya fecha de maduración es el 01/07/2024 y además únicamente contar con las observaciones obtenidas a partir del 10/02/2020, que es donde se tiene registro del bono con fecha de maduración 01-01-2016.

```{r}

#se crea una base de datos homogena
datosBrasil<-datosBrasil%>%filter(FechaDeValoracion>=as.Date("10/02/2020",format="%d/%m/%Y"), FechaDeMaduracion!=as.Date("01/07/2024",format="%d/%m/%Y"))

datosDes<-datosDes%>%filter(FechaDeValoracion>=as.Date("10/02/2020",format="%d/%m/%Y"), FechaDeMaduracion!="2024-07-01")


datosDes[datosDes$TipoDeBono=="CeroCupón",]%>%ggplot(aes(x=FechaDeValoracion, y = Precio, group=FechaDeMaduracion, color=FechaDeMaduracion))+
  geom_line()+
  scale_color_discrete(name = "Fecha de maduración")+
  labs(y = "Precios",x = "Tiempo",title = "Comportamiento de bonos cero cupón")+
  theme(legend.position="bottom")+
  theme(plot.title = element_text(hjust = .5))

datosDes[datosDes$TipoDeBono=="Cuponados",]%>%ggplot(aes(x=FechaDeValoracion, y = Precio,group=FechaDeMaduracion, color=FechaDeMaduracion))+
  geom_line()+
  scale_color_discrete(name = "Fecha de maduración")+
  labs(y = "Precios",x = "Tiempo", title = "Comportamiento de bonos cuponados")+
  theme(legend.position="bottom")+
  theme(plot.title = element_text(hjust = .5))
```
\par Tras la homogenización de datos se tienen un total de `r length(datosBrasil$Precio) ` observaciones teniendo que las mismas van desde el `r min(datosBrasil$FechaDeValoracion)` hasta `r max(datosBrasil$FechaDeValoracion)`.

\par Realizando un análisis de los precios ve aprecia claramente la incidencia de los efectos causados por el COVID-19 en la economía en el mes de mayo y su pronta recuperación en el mes de abril, esto para ambos tipos de bonos.

\par Se puede apreciar la respuesta que se tuvo con los bonos cero cupón se intensifica a medida que su fecha de maduración aumenta; teniendo así que el bono con año de maturación 2022, se mantiene más estable que los demás, pues se acerca a su valor facial.

\par En cuanto a los bonos cuponados, estos son más sensible las repercusiones económicas dadas por las medidas tomadas para mitigar del COVID-19, pues se puede apreciar como estos tienen un periodo de relativa estabilidad entre julio y diciembre del 2020, pero a partir de enero del 2021 se ven los efectos de la especulación ante la caida del sistema de salud del país para atender la enfermedad y el descubrimiento de una nueva variante.
#pregunta porque eran más sencible los cuponados



```{r echo=FALSE, message=FALSE, warning=FALSE}

#Se realiza una descripción de los datos observando los efectos de la pandemia.
# Como se puede observar de un periodo de tiempo tan amplio y contando con `r length(datosBrasil$FechaDeValoracion)` observaciones por cada fecha de maduración, la tasa de rendimiento ha variado considerablemente, así que para realizar un análisis de sus datos se cuenta con el siguiente grafico de cajas y dispersión de puntos.

datosDes[datosDes$TipoDeBono=="CeroCupón",]%>%ggplot(aes(x = FechaDeMaduracion, y = Precio, group=FechaDeMaduracion, color=FechaDeMaduracion)) + 
  geom_boxplot(aes(color = FechaDeMaduracion), alpha = 0.7) +
  geom_jitter(aes(color = FechaDeMaduracion), size = 1, alpha = 0.04)+
  #geom_violin(aes(fill = `Fecha de maduración`), color = 'black', alpha = 0.8)+
  scale_color_discrete()+
  xlab('Fecha de maduración') +
  ylab('Tasas spot en %') +
  ggtitle('Distribución de los precios bonos cero cupón') +
  theme_minimal()+theme(axis.text.x=element_blank())



datosDes[datosDes$TipoDeBono=="Cuponados",]%>%ggplot(aes(x = FechaDeMaduracion, y = Precio, group=FechaDeMaduracion, color=FechaDeMaduracion)) + 
  geom_boxplot(aes(color = FechaDeMaduracion), alpha = 0.7) +
  geom_jitter(aes(color = FechaDeMaduracion), size = 1, alpha = 0.04)+
  #geom_violin(aes(fill = `Fecha de maduración`), color = 'black', alpha = 0.8)+
  scale_color_discrete()+
  xlab('Fecha de maduración') +
  ylab('Tasas spot en %') +
  ggtitle('Distribución de los precios bonos cuponados') +
  theme_minimal()+theme(axis.text.x=element_blank())

```


Al analizar estos datos cabe tener presente la siguiente tabla:

``` {r echo=FALSE, message=FALSE, warning=FALSE}
# kable(promedios10Y,col.names = c("Maduración en meses", "Promedio", "Varianza"), format = "latex" , booktabs=TRUE , align = 'clcc' , caption = "Datos estadisticos (10 años)",)%>%
#   kable_styling(full_width = F, position = "center", latex_options = "HOLD_position")
```

\clearpage
Caso para 1 año

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Datosgra1Y<-gather(datos1Y, "Fecha de maduración", Obtenido, names(datos1Y[2]):names(datos1Y[length(datos1Y)]))
# Datosgra1Y$`Fecha de maduración`<-factor(Datosgra1Y$`Fecha de maduración`, levels = c("1_mes","3_meses", "6_meses", "1_año", "2_años", "3_años","5_años","7_años", "10_años","20_años","30_años"))
# 
# 
# ggplot(data = Datosgra1Y, aes(x =`Fecha de maduración` , y = Obtenido, group=`Fecha de maduración`)) +
#   geom_boxplot(aes(color = `Fecha de maduración`), alpha = 0.7) + 
#   geom_jitter(aes(color = `Fecha de maduración`), size = 1, alpha = 0.04)+
#   #geom_violin(aes(fill = `Fecha de maduración`), color = 'black', alpha = 0.8)+
#   scale_color_discrete()+
#   xlab('Fecha de maduración') + 
#   ylab('Tasas spot en %') +
#   ggtitle('Distribución de las tasa spot (1 año)') + 
#   theme_minimal()+theme(axis.text.x=element_blank())
```



Al analizar estos datos cabe tener presente la siguiente tabla:

``` {r echo=FALSE, message=FALSE, warning=FALSE}
# 
# kable(promedios1Y, col.names = c("Maduración en meses", "Promedio", "Varianza"), format = "latex" , booktabs=TRUE , align = 'clcc' , caption = "Datos estadisticos (1 año)",)%>%
#   kable_styling(full_width = F, position = "center", latex_options = "HOLD_position")
```
\clearpage
Caso para un mes

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Datosgra1Mo<-gather(datos1Mo, "Fecha de maduración", Obtenido, names(datos1Mo[2]):names(datos1Mo[length(datos1Mo)]))
# 
# Datosgra1Mo$`Fecha de maduración`<-factor(Datosgra1Mo$`Fecha de maduración`, levels = c("1_mes","3_meses", "6_meses", "1_año", "2_años", "3_años","5_años","7_años", "10_años","20_años","30_años"))
# 
# 
# ggplot(data = Datosgra1Mo, aes(x =`Fecha de maduración` , y = Obtenido, group=`Fecha de maduración`)) + geom_boxplot(aes(color = `Fecha de maduración`), alpha = 0.7) + 
#   geom_jitter(aes(color = `Fecha de maduración`), size = 1, alpha = 0.02)+
#   scale_color_discrete()+
#   xlab('Fecha de maduración') + 
#   ylab('Tasas spot en %') +
#   ggtitle('Distribución de las tasa spot (1 mes)') + 
#   theme_minimal()+theme(axis.text.x=element_blank())
```

Al analizar estos datos cabe tener presente la siguiente tabla:

``` {r echo=FALSE, message=FALSE, warning=FALSE}

# kable(promedios1Mo,col.names = c("Maduración en meses", "Promedio", "Varianza"), format = "latex" , booktabs=TRUE , align = 'clcc' , caption = "Datos estadisticos (1 mes)",)%>%
#   kable_styling(full_width = F, position = "center", latex_options = "HOLD_position")
```







\chapter{Metodología 1}
\par Como ya se mostró en el marco teórico se puede construir la curva de rendimienos de forma continua a partir de \ref{rendimiento}. Sin embargo no se cuenta con los parámetros necesario para la replicación de los rendimientos de los bonos de los datos, pero si se cuenta con los precios de los bonos en fechas determinadas y demás información como las fechas de maduración de los bonos, pago de cupones y los montos pagados.

\par Entonces haciendo uso de la suma de residuo de cuadrados y la programación en \textbf{\textsf{R}} se optimiza \ref{sumaderesiduo}
\[
\sum_{i} (\tilde{P}_i-P(T_i,\theta))^2
\]
\par Para posteriormente graficar \ref{rendimiento}. Para esto se toman las muestras del precio máximo de todos los precios ligado a esto los bonos que fueron valorados la fecha en que se obtuvo este precio, posteriormente se hace el caso del mínimo igual al anterior, mediana y media de los datos agrupados por tipo de bono y fecha de maduración haciendo la suposición de que esta valoración se hizo el 27 de mayo del 2021 y se toma la valoración de los bonos más reciente. Para motrar el ajuste se calculan las tasas spot mediante \ref{ceroCupon}

``` {r echo=FALSE, message=FALSE, warning=FALSE,fig.align="center"}
#### Se toman solos los datos de Brasil que están posterior al primero de enero del 2020
datosBrasil<-datosBrasil%>%filter(FechaDeValoracion>=as.Date("01/01/2020",format="%d/%m/%Y"))
maximo<-max(datosBrasil$Precio)
datosMaximo<-(datosBrasil%>%filter(FechaDeValoracion==datosBrasil$FechaDeValoracion[datosBrasil$Precio==maximo]))
minimo<-min(datosBrasil$Precio)
datosMinimo<-(datosBrasil%>%filter(FechaDeValoracion==datosBrasil$FechaDeValoracion[datosBrasil$Precio==minimo]))
datosRecientes<-(datosBrasil%>%filter(FechaDeValoracion==as.Date("27/05/2021",format="%d/%m/%Y")))
## Se calculan las medianas y se hace como si la valoracion hubiera sido el 27 de mayo del 2021
datosMedianas<-datosBrasil%>%group_by(FechaDeMaduracion,TipoDeBono,CuponSemestral)%>%summarise(Mediana=median(Precio))
datosMedianas$TiempoRestanteParaMaduracion<-sort(datosBrasil$TiempoRestanteParaMaduracion[datosBrasil$FechaDeValoracion==as.Date("27/05/2021",format="%d/%m/%Y")])
### Se calculan las medias
datosMedia<-datosBrasil%>%group_by(FechaDeMaduracion,TipoDeBono,CuponSemestral)%>%summarise(Media=mean(Precio))
datosMedia$TiempoRestanteParaMaduracion<-sort(datosBrasil$TiempoRestanteParaMaduracion[datosBrasil$FechaDeValoracion==as.Date("27/05/2021",format="%d/%m/%Y")])
#### Se calculan los parametros en cada caso
t<-c(0,0,0,0.05)
parametrosMax<-fitNS(t,datosMaximo$TiempoRestanteParaMaduracion,datosMaximo$Precio,1000,datosMaximo$CuponSemestral)
parametrosMin<-fitNS(t,datosMinimo$TiempoRestanteParaMaduracion,datosMinimo$Precio,1000,datosMinimo$CuponSemestral)
parametrosMedia<-fitNS(t,datosMedia$TiempoRestanteParaMaduracion,datosMedia$Media,1000,datosMedia$CuponSemestral)
#Cambio de valor de parametro, para que sean un valor finito
t<-c(0,0,0,0.005)
parametrosMediana<-fitNS(t,datosMedianas$TiempoRestanteParaMaduracion,datosMedianas$Mediana,1000,datosMedianas$CuponSemestral)
parametrosRecientes<-fitNS(t,datosRecientes$TiempoRestanteParaMaduracion,datosRecientes$Precio,1000,datosRecientes$CuponSemestral)
### Se colocan todos en una lista
parametrosGeneral<-list(Máximo=parametrosMax,Mínimo=parametrosMin,Media=parametrosMedia,Mediana=parametrosMediana,Recientes=parametrosRecientes)
### Se genera una tabla
datosCurva<-data.frame(Maduracion=integer(),Tasa=double(),Etiqueta=character())
for (i in 1:length(parametrosGeneral)){
  datosCurvaAuxiliar<-data.frame(Maduracion=seq(0,10,length=100),Tasa=NS(unlist(lapply(parametrosGeneral,"[[",1)[i]),seq(0,10,length=100)),Etiqueta=rep(names(parametrosGeneral)[i],100))
  datosCurva<-rbind(datosCurva,datosCurvaAuxiliar)
}
####Se calcula las tasas spot para los cuatro casos
datosMaximo<-datosMaximo%>%filter(!grepl("com",TipoDeBono))
datosMinimo<-datosMinimo%>%filter(!grepl("com",TipoDeBono))
datosMedia<-datosMedia%>%filter(!grepl("com",TipoDeBono))
datosMedianas<-datosMedianas%>%filter(!grepl("com",TipoDeBono))
datosRecientes<-datosRecientes%>%filter(!grepl("com",TipoDeBono))
datosMaximo$Spot<-(1000/datosMaximo$Precio)^(1/datosMaximo$TiempoRestanteParaMaduracion)-1
datosMedia$Spot<-(1000/datosMedia$Media)^(1/datosMedia$TiempoRestanteParaMaduracion)-1
datosMinimo$Spot<-(1000/datosMinimo$Precio)^(1/datosMinimo$TiempoRestanteParaMaduracion)-1
datosMedianas$Spot<-(1000/datosMedianas$Mediana)^(1/datosMedianas$TiempoRestanteParaMaduracion)-1
datosRecientes$Spot<-(1000/datosRecientes$Precio)^(1/datosRecientes$TiempoRestanteParaMaduracion)-1
datosGeneral<-rbind(cbind(datosMaximo%>%select(TiempoRestanteParaMaduracion,Spot),Etiqueta=c("Máximo")),cbind(datosMinimo%>%select(TiempoRestanteParaMaduracion,Spot),Etiqueta=c("Mínimo")),cbind(as.data.frame(datosMedia)%>%select(TiempoRestanteParaMaduracion,Spot),Etiqueta=c("Media")),cbind(as.data.frame(datosMedianas)%>%select(TiempoRestanteParaMaduracion,Spot),Etiqueta=c("Mediana")),cbind(as.data.frame(datosRecientes)%>%select(TiempoRestanteParaMaduracion,Spot),Etiqueta=c("Recientes")))
### Se genera el gráfico
curvaYield<-ggplot()+geom_line(datosCurva,mapping=aes(x=Maduracion,y=Tasa,color=Etiqueta))+geom_point(datosGeneral,mapping=aes(x=TiempoRestanteParaMaduracion,y=Spot,color=Etiqueta))+ggtitle("Curvas De Rendimiento (Tesoro Nacional Brasil)",subtitle = "Modelo Nelson-Siegel")+labs(caption="Fuente: Elaboración Propia, datos Tesouro Direto (2021)",x="Rendimiento")
curvaYield
#### Se procede a generar un csv con los resultados para ser leido en la parte del resumen ejecutivo
datosResumen<-data.frame(Caso=character(),"Fecha De Valoración"=as.Date(character()),theta_0=double(),theta_1=double(),theta_2=double(),theta_3=double(),Error=double())
for(i in 1:length(parametrosGeneral)){
  resumenAuxiliar<-data.frame(Caso=names(parametrosGeneral)[i],theta_0=unlist(lapply(parametrosGeneral,"[[",1)[i])[1],theta_1=unlist(lapply(parametrosGeneral,"[[",1)[i])[2],theta_2=unlist(lapply(parametrosGeneral,"[[",1)[i])[3],theta_3=unlist(lapply(parametrosGeneral,"[[",1)[i])[4],Error=unlist(lapply(parametrosGeneral,"[[",2)[i]))
  datosResumen<-rbind(datosResumen,resumenAuxiliar)
}
fechasValoracion<-rbind(toString(datosMaximo$FechaDeValoracion[1]),toString(datosMinimo$FechaDeValoracion[1]),"2021-05-27","2021-05-27","2021-05-27")
datosResumen<-cbind("Fechas de Valoracion"=fechasValoracion,datosResumen)
write.csv(datosResumen,"datosResumenParametros.csv")
```







``` {r echo=FALSE, message=FALSE, warning=FALSE}
### Se procede a calcular a los parametros

## Se guaradan los datos importantes
# t<-c(0,0,0,0.03)
# fitting1Mo<-fitNS(t,promedios1Mo$Maduration,promedios1Mo$Rendimiento)
# paramters1Mo<-unlist(fitting1Mo[1])
# 
# fitting1Y<-fitNS(c(0,0,0,0.01),promedios1Y$Maduration,promedios1Y$Rendimiento)
# paramters1Y<-unlist(fitting1Y[1])
# 
# fitting10Y<-fitNS(t,promedios10Y$Maduration,promedios10Y$Rendimiento)
# paramters10Y<-unlist(fitting10Y[1])
# ### Ploteamos
# time<-seq(from=0,to=360,by=1)
# 
# ggplot()+geom_line(aes(x=time,y=NS(paramters1Mo,time)))+
#   geom_point(aes(x=promedios1Mo$Maduration,y=promedios1Mo$Rendimiento))+ ggtitle("Modelo de Nelsol y Siegel, el promdio del ultimo mes")
# 
# ggplot()+geom_line(aes(x=time,y=NS(paramters1Y,time)))+
#   geom_point(aes(x=promedios1Y$Maduration,y=promedios1Y$Rendimiento))+ ggtitle("Modelo de Nelsol y Siegel, el promdio del ultimo año")
# 
# ggplot()+geom_line(aes(x=time,y=NS(paramters10Y,time)))+
#   geom_point(aes(x=promedios10Y$Maduration,y=promedios10Y$Rendimiento))+ ggtitle("Modelo de Nelsol y Siegel, el promdio de los ultimos 10 años")
```

\chapter{Conclusiones y recomendaciones 1}



\chapter{Referencias bibliográficas}
\nocite{*}
\printbibliography

\chapter{Anexos}
