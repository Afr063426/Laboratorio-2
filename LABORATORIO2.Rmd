---
output:
  pdf_document:
    toc: true
    toc_depth: 2
    includes:
      in_header: preambulo.tex
      before_body: titulo.tex
     
documentclass: memoir
classoption: oneside

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
###Se cargan los paquetes y se cargan y limpian los datos
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(knitr)
library(xtable)
library(gridExtra)
library(latex2exp)


### Se cargan los datos
datosBrasil<-read.csv('datosCombiandos.csv')
datosBrasil$Data.Vencimento<-as.Date(datosBrasil$Data.Vencimento)
datosBrasil$Data.Base<-as.Date(datosBrasil$Data.Base)
```



``` {r echo=FALSE, message=FALSE, warning=FALSE}
### Se programa las funciones que se van emplear
##Modelo de Nelson-Siegel para curvas de rendimiento
NS<-function(theta,tiempo){
  yield<-(theta[1]+(theta[2]+theta[3]/theta[4])*(1-exp(-theta[4]*tiempo))/(theta[4]*tiempo)-theta[3]/theta[4]*exp(-theta[4]*tiempo))
  yield
}

## Se debe ajustar la curva con los precios entonces esto se busca reducir la suma de cuadrados, con la siguiente funci'on
fitNS<-function(theta,tiempo,price,R){
  fn<-function(theta){
    sum((price-R*exp(-tiempo*NS(theta,tiempo)))^2)
  }
  optim(theta,
        fn,
        method = "L-BFGS-B",
        lower= rep(-6,4),
        upper=rep(6,4)
        )
}

###Prueba
datosBrasil<-datosBrasil%>%group_by(Data.Vencimento)
datosBrasil$agrupacion<-paste(datosBrasil$Tipo.Titulo,datosBrasil$Data.Vencimento)
datosBrasil%>%ggplot(aes(x=Data.Base,y=PU.Base.Manha,group=agrupacion,color=agrupacion))+geom_line()
datosPrueba<-datosBrasil%>%filter(Data.Base==as.Date("27/05/2021", format="%d/%m/%Y"))
t<-c(0,0,0,0.05)
valores<-fitNS(t,datosPrueba$TempoDeMaduracao,datosPrueba$PU.Base.Manha,1000)
parametros<-unlist(valores[1])
yields<-NS(parametros,seq(from=1,to=6,length=100))
ggplot(,aes(x=seq(from=1,to=6,length=100),y=yields))+geom_line()
datosBrasil<-datosBrasil%>%filter(Data.Base>=as.Date("01/05/2021",format="%d/%m/%Y"))
```


\chapter{Resumen Ejecutivo 1}
Aquí debe dar resultados generales de lo que obtuvo del análisis.

\chapter{Introducción 1}

\chapter{Objetivos 1}

\section{Objetivo general}

Analizar la curva de rendimiento de los bonos del tesoro de Estados Unidos de Norte América por medio del modelo de Nelson y Siegel en el periodo de años comprendido entre el 1° de enero del 2010 y el  20 de mayo del 2021.

\section{Objetivos específicos}
\begin{enumerate} 

\item Explicar el modelo de Nelson y Siegel.

\item Describir las características de la base de datos de bonos Tesouro Prefixado.

\item Implementar el modelo de Nelson y Siegel en lenguaje de programación R, para la base de datos de los bonos del tesoro de bonos Tesouro Prefixado.

\item Evaluar los resultados obtenidos apartir del modelo de Nelson y Siegel.

\end{enumerate}





\chapter{Marco teórico 3}
\par La curva de rendimiento es una herramienta útil a la hora de quererse invertir o negociar un instrumento financiero y al momento de aplicar políticas monetarias. Primero se presenta una tabla con fórmulas y qué representan cada una

\begin{table}[H]
\centering
\begin{tabular}{cc}
\hline
Notación & Información\\
\hline 
$y_T$   & Tasa de rendimiento\\
$y_k$ & Tasa Spot, es la tasa pagada. Ligada al tiempo de maduración.\\
$f_k$ & La tasa forward es la tasa efectiva en un año o periodo dadas las spot $\frac{(1+y_k)^{k}}{(1+y_{k-1})^{k-1}}-1$\\
$T$   & Tiempo para la maduración.               \\
$B_0$ & Costo de la inversión o precio del bono. \\
$F$   & Facial, también puede ser igual al valor de redención pero no siempre es así.\\  
$R$ & Valor de redención, es el monto pagado a parte de los cupones\\
$C$ & Tasa de cupón que se paga de forma periodica que se hace sobre el valor del facial.\\
\hline
\end{tabular}
\end{table}
\par Se procede a explicar qué es la curva de rendimiento, según Boudreault y Reanud (2019) la curva de rendimiento también llamada curva de rendimientos spot, esta curva muestra la relación que hay entre las tasa de rendimiento spot y el tiempo de maduración. Así esta curva muestra los rendimientos que se obtienen de mantener una cierta cantidad de dinero durante un tiempo determinado. Para el caso de bonos cero cupón se puede calcular usando
\[
y=\left(\frac{F}{B_0}\right)^{\frac{1}{T}}-1
\]
\par Cabe destacar que si ya se tiene la tasa spot de los anterior se puede determinar el precio del bono. Para el caso de los bonos cuponados el precio se calcularía usando
\[
B_0=\sum_{i=1}^{T}\frac{CF}{(1+y_i)^{i}}+\frac{R}{(1+y_T)^T}
\]
\par Sin embargo a pesar de que esta herramienta es ampliamente utilizada, tiene una limitante intertemporal. Como lo expone Camilo (2008) esta se construye a través de una serie de tasas (precios) de instrumentos financieros discontinuos en el tiempo. Esto implica que entonces lo se ubica a partir de las tasas de rendimiemto es una serie de puntos que no reflejan de forma continua las tasas de rendimiento en el mercado financiero de acuerdo a su tiempo de maduración.
\par Sin embargo hay agentes los cuales no están dispuestos a invertir o prestar los montos al tiempo establecido por agentes como los gobiernos nacionales u otras empresas. Es por esta razón que sería de utilidad encontrar una curva suave la cual sea capaz de proyectar las tasas de rendimiento en distintos momentos del tiempo, pero basado en lo que anteriormente han establecido agentes como los gobiernos nacionales.
\par Para lograr obtener una curva suave la cual se aproxime a las tasas de rendimiento de agentes como los gobiernos, se emplean distintos métodos entre ellos los métodos paramétricos que están basados en la construcción de curvas a partir de modelos paramétricos. (Choudhry, 2010)
\par Entre los modelos paramétricos se encuentra el de Nelson-Siegel. El cual según Matteson (2015) describe las tasas forward con la siguiente curva
\[
f(t,\theta)=\theta_0+(\theta_1+\theta_2t)\exp(-\theta_3 t)
\]
A partir de esta se puede obtener que la curva de rendimiento continua se puede obtener haciendo
\[
\begin{split}
y(t,\theta)&=t^{-1}\int_{0}^{t}r(x,\theta)dx\\
&=\theta_0+\left(\theta_1+\frac{\theta_2}{\theta_3}\right)\frac{1-\exp(-\theta_3 t)}{\theta_3 t}-\frac{\theta_2}{\theta_3}\exp(-\theta t)
\end{split}
\]
Tal y como lo citan Hladíková y Radová (2012) este modelo tiene una interpretación económica interesante para los parámetros. Tomando la curva que describe las tasas forward 
Primero
\[
\lim_{t\to\infty}f(t,\theta)=\theta_{0}\qquad \lim_{t\to 0}f(t,\theta)=\theta_0+\theta_1
\]
\begin{itemize}
\item Entonces $\theta_0>0$ representa la asintota de la curva zero cupón
\item La suma de los parámetros $\theta_0+\theta_1$ representa el valor inicial de la curva de tasas forward por lo que $\theta_0+\theta_1>0$
\item También $\theta_1$ puede es explicada como la curvatura de la función o la diferencia entre las tasas de forward de termino largo y termino corto.
\end{itemize}
\par Antes de poder continuar es necesario dejar en claro lo que es la desviación estandar, 
\par Se procede a explicar los gráficos de caja y bigotes. Estos gráficos muestran 5 datos relevantes de los datos, así como la disperción. En estos se muestran el dato con el valor más bajo (mínimo), la mediana de la primera mitad de los datos (cuartil 1, $Q_1$), la mediana de todos los datos (cuartil 2, $Q_2$), la mediana de la segunda mitad de los datos (cuartil 3 $Q_3$) y la observación de mayor valor (máximo), así como los posibles outliers. De los gráficos de caja y bigotes existen variaciones. Al momento de hacerse un gráfico de este estilo hay que tener presente varias desventajas como lo, es el visualizar como están distribuidos los datos, con respecto a los distintos cuartiles. (Marmolejo, 2011) 
\par\centering
``` {r echo=FALSE, message=FALSE, warning=FALSE,fig.width=5, fig.height=2}
caja<-data.frame(X=c(""),Y=c(1:5))
caja%>%ggplot(aes(x=X,y=Y,label=c('Min','Q_1','M','Q_3','Max')))+stat_boxplot(geom='errorbar')+geom_boxplot()+geom_text(vjust=6)+theme_minimal()+theme(axis.text.x=element_blank(),axis.text.y=element_blank())+coord_flip()
```

\chapter{Descripción de los datos 5}
\par Profesora, estuvimos investigado bases de datos donde nos dieran como insumo el precio de los bonos, nos encontramos con varios inconvenientes de las misma:
\begin{enumerate} 

\item El registro de datos es muy corto, aproximadamente 1 mes como mucho, más que todo datos eran de un día específico y no guardan registro de los anteriores.
\item En Bonos cero cupones, para calcular las tasas, el plazo de maduración máximo fue a 10 años, posterior a 10 años tienen cupón y no se puede hacer bootstrapping.
\item	No se tiene presente la tasa de descuento para estos bonos de más de 10 años, por lo que no se puede traer a valor presente, para calcular su respectiva tasa de pendiente 
\item	Estos inconvenientes se mantenían en todas las bases de datos que hemos encontrado, las cuales han sido muy pocas por el siguiente punto.
\item	En sus mayorías las bases de datos con una cantidad aceptable de observaciones se encuentran las tasas de rendimiento (spot)

\end{enumerate}
\par Tal vez nos podría dar alguna indicación con respecto a estas bases de datos o sugerir una en específico, para así poder avanzar en el desarrollo del proyecto o en su defecto trabajarlo solo con las bases de datos que contienen a las tasas de rendimientos, como la que se está trabajando en este momento.
\par Por lo anterior le presentamos dos ideas para desarrollar el trabajo, la primera partiendo de los precios de los bonos con una base de datos que a nuestro parecer no es la mejor, pues no cuenta con amplitud de observaciones ni rendimientos a largo plazo y la segunda con una base de datos que cuenta con las tasas de rendimiento únicamente, pero con grandes cantidades de observaciones y amplitud de fechas de maduración.



\clearpage

\section{Opción 1}



\par Encontramos los datos de la región de Asia descargados el día 21 de mayo del 2021 de la página https://es.tradingview.com/markets/bonds/prices-asia/ . Lo que sucede con estos datos es que algunos bonos cuentan con cupones y no se cuenta con las tasas para traer los flujos a valor presente. 

\par Lo que pensamos es que se podría hacer es intentar calcular las tasas spot de una forma similar a la que se presenta en el código de la metodología el último gráfico donde basado en los cupones y precio del bono, así como su tiempo de maduración se usa el modelo de Nelson y Siegel. Se planteaba la idea de sacar las tasas para los países de la región y sacar un promedio de estas para visualizar cuáles podrían ser las tasas de los bonos en esta región (pues no se cuenta con el resgistro historico). La idea de implementar lo que se hizo a la metodología surgió del hecho de no poder hacer bootstraping cuando habían saltos de más de un año entre periodos y teniendo en cuenta que se tenían cupones.
\par Se muestra un análisis de los datos unificados por tiempo de maduración del bono ignorando el país.


``` {r echo=FALSE, message=FALSE, warning=FALSE}
datosAsia<-datosAsia%>%group_by(Maduration)
ggplot(data = datosAsia, aes(x =Maduration , y = Precio, group=Maduration,color=Maduration)) + 
  geom_boxplot( alpha = 0.1) + 
   geom_jitter(aes(color = Maduration), size = 1, alpha = 0.2)+
  xlab('Fecha de maduración') + 
  ylab('Precio') +
  ggtitle('Distribución de los precios Asia') + 
  theme_minimal()
```
Al analizar estos datos cabe tener presente la siguiente tabla:

``` {r echo=FALSE, message=FALSE, warning=FALSE}
promediosAsia<-datosAsia%>%group_by(Maduration)%>%summarise_all(mean)

promediosAsia<-promediosAsia[,c(-2:-4)]

promediosAsia<-cbind(promediosAsia, "Varianza"=datosAsia[,c(4,5)]%>%group_by(Maduration)%>%summarise_all(sd))
promediosAsia<-promediosAsia[,c(-3)]

kable(promediosAsia,col.names = c("Maduración", "Promedio", "Varianza"), format = "latex" , booktabs=TRUE , align = 'clcc' , caption = "Datos estadisticos precios de Asia",)%>%
  kable_styling(full_width = F, position = "center", latex_options = "HOLD_position")
```


\section{Opción 2}
Se parte de la base de datos que contiene las tasas de rendimiento, seleccionan sus ultimos 10 años, que van desde `r datos10Y$Date[1]` hasta `r datos10Y$Date[length(datos10Y$Date)]` y cuenta con las tasas de rendimientos diarias de bonos con fecha de maduración a: 1 mes, 6 meses, 1 año, 2 años, 3 años, 5 años, 7 años, 10 años, 20 años y 30 años. En el siguiente grafico se aprecia como varia la tasa de rendimiento atreves del tiempo.

```{r echo=FALSE, message=FALSE, warning=FALSE}
Datosgra10Y<-gather(datos10Y, "Fecha de maduración", Obtenido, names(datos10Y[2]):names(datos10Y[length(datos10Y)]))

ggplot( data =Datosgra10Y, mapping = aes(x = Date, y = Obtenido, group=`Fecha de maduración`, color=`Fecha de maduración`)) + 
    geom_line()+
    scale_color_discrete()+
      labs(
      y = "Tasa de rendimiento en %",
      x = "Tiempo",
      title = "Comportamiento de las tasas spot"
      ) +
    theme(legend.position="bottom")+
    theme(plot.title = element_text(hjust = .5))# colocamos el titulo en el centro
```
Se realiza una descripción de los datos observando los efectos de la pandemia.
Como se puede observar de un periodo de tiempo tan amplio y contando con `r length(datos10Y$Date)` observaciones por cada fecha de maduración, la tasa de rendimiento ha variado considerablemente, así que para realizar un análisis de sus datos se cuenta con el siguiente grafico de cajas y dispersión de puntos.

```{r echo=FALSE, message=FALSE, warning=FALSE}
Datosgra10Y$`Fecha de maduración`<-factor(Datosgra10Y$`Fecha de maduración`, levels = c("1_mes","3_meses", "6_meses", "1_año", "2_años", "3_años","5_años","7_años", "10_años","20_años","30_años"))

ggplot(data = Datosgra10Y, aes(x =`Fecha de maduración` , y = Obtenido, group=`Fecha de maduración`)) + 
  geom_boxplot(aes(color = `Fecha de maduración`), alpha = 0.7) + 
  geom_jitter(aes(color = `Fecha de maduración`), size = 1, alpha = 0.04)+
  #geom_violin(aes(fill = `Fecha de maduración`), color = 'black', alpha = 0.8)+
  scale_color_discrete()+
  xlab('Fecha de maduración') + 
  ylab('Tasas spot en %') +
  ggtitle('Distribución de las tasa spot (10 años)') + 
  theme_minimal()+theme(axis.text.x=element_blank())
```


Al analizar estos datos cabe tener presente la siguiente tabla:

``` {r echo=FALSE, message=FALSE, warning=FALSE}
kable(promedios10Y,col.names = c("Maduración en meses", "Promedio", "Varianza"), format = "latex" , booktabs=TRUE , align = 'clcc' , caption = "Datos estadisticos (10 años)",)%>%
  kable_styling(full_width = F, position = "center", latex_options = "HOLD_position")
```

\clearpage
Caso para 1 año

```{r echo=FALSE, message=FALSE, warning=FALSE}
Datosgra1Y<-gather(datos1Y, "Fecha de maduración", Obtenido, names(datos1Y[2]):names(datos1Y[length(datos1Y)]))
Datosgra1Y$`Fecha de maduración`<-factor(Datosgra1Y$`Fecha de maduración`, levels = c("1_mes","3_meses", "6_meses", "1_año", "2_años", "3_años","5_años","7_años", "10_años","20_años","30_años"))


ggplot(data = Datosgra1Y, aes(x =`Fecha de maduración` , y = Obtenido, group=`Fecha de maduración`)) +
  geom_boxplot(aes(color = `Fecha de maduración`), alpha = 0.7) + 
  geom_jitter(aes(color = `Fecha de maduración`), size = 1, alpha = 0.04)+
  #geom_violin(aes(fill = `Fecha de maduración`), color = 'black', alpha = 0.8)+
  scale_color_discrete()+
  xlab('Fecha de maduración') + 
  ylab('Tasas spot en %') +
  ggtitle('Distribución de las tasa spot (1 año)') + 
  theme_minimal()+theme(axis.text.x=element_blank())
```



Al analizar estos datos cabe tener presente la siguiente tabla:

``` {r echo=FALSE, message=FALSE, warning=FALSE}

kable(promedios1Y, col.names = c("Maduración en meses", "Promedio", "Varianza"), format = "latex" , booktabs=TRUE , align = 'clcc' , caption = "Datos estadisticos (1 año)",)%>%
  kable_styling(full_width = F, position = "center", latex_options = "HOLD_position")
```
\clearpage
Caso para un mes

```{r echo=FALSE, message=FALSE, warning=FALSE}
Datosgra1Mo<-gather(datos1Mo, "Fecha de maduración", Obtenido, names(datos1Mo[2]):names(datos1Mo[length(datos1Mo)]))

Datosgra1Mo$`Fecha de maduración`<-factor(Datosgra1Mo$`Fecha de maduración`, levels = c("1_mes","3_meses", "6_meses", "1_año", "2_años", "3_años","5_años","7_años", "10_años","20_años","30_años"))


ggplot(data = Datosgra1Mo, aes(x =`Fecha de maduración` , y = Obtenido, group=`Fecha de maduración`)) + geom_boxplot(aes(color = `Fecha de maduración`), alpha = 0.7) + 
  geom_jitter(aes(color = `Fecha de maduración`), size = 1, alpha = 0.02)+
  scale_color_discrete()+
  xlab('Fecha de maduración') + 
  ylab('Tasas spot en %') +
  ggtitle('Distribución de las tasa spot (1 mes)') + 
  theme_minimal()+theme(axis.text.x=element_blank())
```

Al analizar estos datos cabe tener presente la siguiente tabla:

``` {r echo=FALSE, message=FALSE, warning=FALSE}

kable(promedios1Mo,col.names = c("Maduración en meses", "Promedio", "Varianza"), format = "latex" , booktabs=TRUE , align = 'clcc' , caption = "Datos estadisticos (1 mes)",)%>%
  kable_styling(full_width = F, position = "center", latex_options = "HOLD_position")
```







\chapter{Metodología 1}
Cómo implementa la teoría expuesta en el marco teórico con sus datos, colocaremos aquí los resultados que se vayan obteniendo, incluir al menos un gráfico.


\section{Opción 1}

En vista de que no podiamos hacer boostraping hasta los 30 años, lo que hicimos es tratar de generar los parámetros trayendo a valor presente los flujos y restar los al precio presente. Eso es lo que se muestra acontinuación. Solo se está aplicando  para el caso de Japón a 30 años sin embargo se pensó en hacerse para todos los demás paises y así sacar un promedio de lo podrían ser las tasas de rendimiento en el área de Asia. Comprendiendido Japón, India, Corea, China, Hong Kong, Taiwan, Indonesia, Malasia y Tailandia. Estos datos corresponden al dia 21 de mayo del 2021.
\par También se pensó en calcular las tasas de forma directa a partir de los precio sin embargo los únicos periodos para los que se encontraron cero cupón eran de 1 mes a 10 años y de ahí en adelante todos los demás tenían cupones







\section{Opción 2}



``` {r echo=FALSE, message=FALSE, warning=FALSE}
### Se procede a calcular a los parametros

## Se guaradan los datos importantes
t<-c(0,0,0,0.03)
fitting1Mo<-fitNS(t,promedios1Mo$Maduration,promedios1Mo$Rendimiento)
paramters1Mo<-unlist(fitting1Mo[1])

fitting1Y<-fitNS(c(0,0,0,0.01),promedios1Y$Maduration,promedios1Y$Rendimiento)
paramters1Y<-unlist(fitting1Y[1])

fitting10Y<-fitNS(t,promedios10Y$Maduration,promedios10Y$Rendimiento)
paramters10Y<-unlist(fitting10Y[1])
### Ploteamos
time<-seq(from=0,to=360,by=1)

ggplot()+geom_line(aes(x=time,y=NS(paramters1Mo,time)))+
  geom_point(aes(x=promedios1Mo$Maduration,y=promedios1Mo$Rendimiento))+ ggtitle("Modelo de Nelsol y Siegel, el promdio del ultimo mes")

ggplot()+geom_line(aes(x=time,y=NS(paramters1Y,time)))+
  geom_point(aes(x=promedios1Y$Maduration,y=promedios1Y$Rendimiento))+ ggtitle("Modelo de Nelsol y Siegel, el promdio del ultimo año")

ggplot()+geom_line(aes(x=time,y=NS(paramters10Y,time)))+
  geom_point(aes(x=promedios10Y$Maduration,y=promedios10Y$Rendimiento))+ ggtitle("Modelo de Nelsol y Siegel, el promdio de los ultimos 10 años")
```

\chapter{Conclusiones y recomendaciones 1}



\chapter{Referencias bibliográficas}
\nocite{*}
\printbibliography

\chapter{Anexos}
